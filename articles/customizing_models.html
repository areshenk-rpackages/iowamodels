<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Adding new models • iowamodels</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adding new models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">iowamodels</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Models</h6></li>
    <li><a class="dropdown-item" href="../articles/model_structure.html">Model structure</a></li>
    <li><a class="dropdown-item" href="../articles/utility_functions.html">Utility functions</a></li>
    <li><a class="dropdown-item" href="../articles/updating_functions.html">Updating functions</a></li>
    <li><a class="dropdown-item" href="../articles/temperature_functions.html">Temperature functions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Adding to iowa</h6></li>
    <li><a class="dropdown-item" href="../articles/customizing_models.html">Adding new models</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Adding new models</h1>
                        <h4 data-toc-skip class="author">Corson N.
Areshenkoff</h4>
            
            <h4 data-toc-skip class="date">2024-08-06</h4>
      

      <div class="d-none name"><code>customizing_models.Rmd</code></div>
    </div>

    
    
<p>Adding new model components (e.g. new utility functions) involves two
broad steps:</p>
<ul>
<li>Making the component available to stan, which is responsible for all
model simulation and fitting.</li>
<li>Updating <strong>iowamodels</strong>’s internal information about
the model component, including parameter names, bounds, etc.</li>
</ul>
<p>Although the actual process of adding a new component is slightly
tedious, the ultimate goal is that, once added, the new component can be
used with all package functions (and combined with all other components)
with a minimum of thought or fuss.</p>
<div class="section level3">
<h3 id="internal-package-structure">Internal package structure<a class="anchor" aria-label="anchor" href="#internal-package-structure"></a>
</h3>
<p>The general structure of the package is as follows:</p>
<ul>
<li>External packages (such as <strong>iowa</strong>) interface with
<strong>iowamodels</strong> through wrapper functions such as
<code>simulateIGT()</code> and <code>fitIGT()</code>, which provide a
high-level interface to the cmdstan models implemented in
<strong>iowamodels</strong>.</li>
<li>Models are implemented in
<code>src/stan/&lt;modelfile&gt;&gt;.stan</code>.</li>
<li>The actual component functions (e.g. the specific utility function)
are passed internally as data to the stan model, which are then imported
from a separate <code>.stan</code> file. These separate files are stored
in <code>src/stan/include</code>, with the names e.g.
<code>utilityFunctions.stanfunctions</code>.</li>
</ul>
<p>For example, <code>src/stan/fitIGT.stan</code> – which is responsible
for model fitting – specifies a general model as follows:</p>
<pre><code>// Likelihood
for (t in 1:NUM_TRIALS){

    // Compute temperature
    theta = temperature(t, temperature_params, TEMPERATURE_FUNCTION);

    // Draw card
    choice[t] ~ categorical_logit(theta * V);

    // Compute utility
    U = utility(win[t], loss[t], utility_params, UTILITY_FUNCTION);

    // Update deck values
    V = updating(V, U, choice[t], updating_params, UPDATING_FUNCTION);
}</code></pre>
<p>On trial <code>t</code>, the utility of the outcome is evaluated
through the function</p>
<pre><code><span><span class="fu">utility</span><span class="op">(</span><span class="va">win</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, <span class="va">loss</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, <span class="va">utility_params</span>, <span class="va">UTILITY_FUNCTION</span><span class="op">)</span>;</span></code></pre>
<p>where <code>utility</code> is imported from
<code>src/stan/include/utilityWrapper.stanfunctions</code>, and is
defined by</p>
<pre><code>real utility(real win, real loss, array[] real par, int ind){

    if (ind == 1){
        return utility_EU(win, loss, par);
    } else if (ind == 2){
        return utility_PU(win, loss, par);
    } else if (ind == 3){
        return utility_PU2(win, loss, par);
    } else {
        return 0;
    }
}</code></pre>
<p>Note that this function is just a general wrapper that calls one of
several utility functions depending on the integer argument
<code>ind</code>. In turn, all utility functions are defined in
<code>inst/stan/include/utilityFunctions.stan</code>.</p>
<p>As an example, the EU and PU utility are defined by:</p>
<pre><code>// EU utility function (used in EV model)
real utility_EU(real win, real loss, array[] real par) {
    return (1-par[1]) * win - par[1] * loss;
}

// Prospect utility function
real utility_PU(real win, real loss, array[] real par) {
    real net = win - loss;
    if (net &gt;= 0){
        return pow(net, par[1]);
    } else {
        return -par[2] * pow(abs(net), par[1]);
    }
}</code></pre>
<p>Note an important point: <strong>All utility functions have exactly
the same signature</strong>; that is
<code>real win, real loss, array[] real par</code>.</p>
<p>The package in turn contains a <code>modelDetails</code> object
contained in <code>R/sysdata.rda</code>. This structure is a nested list
containing information about each model component; such as its required
parameters, and any necessary (or default) bounds.</p>
<p>The structure of this list is as follows:</p>
<pre><code>modelDetails
.  utility
. .  EU
. . .  index = 1
. . .  pars
. . . .  w
. . . . .  bounds = c(0,1)
. . . . .  default_bounds = c(0, 1)
. . . . .  description = "Win/loss weighting"
. . . . .  index = 1
. .  PU
. . .  index = 2
. . .  pars
. . . .  A
. . . . .  bounds = c(0, Inf)
. . . . .  default_bounds = c(0, 1)
. . . . .  description = "Concavity of utility function"
. . . . .  index = 1
. . . .  L
. . . . .  bounds = c(0, Inf)
. . . . .  default_bounds = c(0, 5)
. . . . .  description = "Loss aversion"
. . . . .  index = 2</code></pre>
<p>That is, it has fields <code>utility</code>, <code>updating</code>,
and <code>temperature</code>; each of which is a named list with fields
corresponding to each included function. The field <code>index</code>
indicates the corresponding value of <code>ind</code> in the stan
wrapper function (e.g. <code>utility(..., ind = 1)</code> chooses the EV
utility), while the index within each parameter field specifies the
position of each parameter in the <code>par</code> argument. The
parameter fields also contain entries giving parameter bounds (outside
of which the package will throw an error), as well as default bounds
used for model fitting if the user does not specify their own.</p>
<p>The general structure of the package program is illustrated below,
using the utility function as an example:</p>
<p><img src="figures/stan_diagram.png" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="implementing-a-new-model-component">Implementing a new model component<a class="anchor" aria-label="anchor" href="#implementing-a-new-model-component"></a>
</h3>
<p>Adding a new utility function to <strong>iowamodels</strong> now
involves the following steps:</p>
<ol style="list-style-type: decimal">
<li>Add the function to
<code>src/stan/include/utilityFunctions.stanfunctions</code>, making
sure that it matches the required signature.</li>
<li>Add a new <code>if</code> statement to
<code>src/stan/include/utilityWrapper.stanfunctions</code>,
corresponding to the next highest value of <code>ind</code>.</li>
<li>Add a new field to <code>modelDetails</code> in the
<code>utility</code> field – named with the unique keyword of the new
utility function – and populate it with the necessary fields (i.e. one
subfield for each parameter, each with the required fields
<code>bounds</code> and <code>default_bounds</code>). The index field
must correspond to the value of <code>ind</code> which calls the new
utility function in step (2).</li>
<li>Resave <code>modelDetails</code> to <code>R/sysdata.rda</code> using
<code>save(modelDetails, file = 'R/sysdata.rda')</code>.</li>
</ol>
<p>After the package is recompiled, the new utility function should be
ready for use.</p>
<p>The steps for adding new updating or temperature functions are
essentially identical, <em>mutatis mutandis</em>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://areshenk.github.io/" class="external-link"><img src="https://areshenk.github.io/about/sidebar/avatar.jpg" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
